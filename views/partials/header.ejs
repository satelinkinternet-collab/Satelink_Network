<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satelink Network Dashboard</title>
    <!-- We inject Tailwind via CDN for JIT compilation of our new classes, falling back to app.css for static parts -->
    <link rel="stylesheet" href="/css/app.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Outfit"', 'sans-serif'],
                        mono: ['"Fira Code"', 'monospace'],
                    },
                    colors: {
                        satelink: {
                            base: '#070A11',
                            surface: 'rgba(15, 23, 42, 0.65)',
                            accent: '#0ea5e9',
                            success: '#10b981',
                            warning: '#f59e0b',
                            error: '#ef4444',
                            text: '#f8fafc',
                            muted: '#94a3b8',
                            border: 'rgba(255, 255, 255, 0.08)'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 10px rgba(14, 165, 233, 0.2)' },
                            '100%': { boxShadow: '0 0 25px rgba(14, 165, 233, 0.6)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Global High-Tech Glassmorphism & Dark Mode Overrides */
        body {
            background-color: #070A11;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(14, 165, 233, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 50% 100%, rgba(245, 158, 11, 0.03) 0%, transparent 50%);
            background-attachment: fixed;
            color: #f8fafc;
            min-height: 100vh;
        }

        /* Override generic EJS classes safely without touching 20 files */
        .bg-white { 
            background: rgba(15, 23, 42, 0.6) !important; 
            backdrop-filter: blur(12px) !important; 
            -webkit-backdrop-filter: blur(12px) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important; 
            color: #f8fafc !important; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
        }
        .text-gray-900 { color: #ffffff !important; font-weight: 600 !important; }
        .text-gray-800 { color: #f1f5f9 !important; }
        .text-gray-700 { color: #e2e8f0 !important; }
        .text-gray-600 { color: #cbd5e1 !important; }
        .text-gray-500 { color: #94a3b8 !important; }
        .bg-gray-50 { background-color: rgba(30, 41, 59, 0.4) !important; color: #f8fafc !important; }
        .bg-gray-100 { background-color: rgba(30, 41, 59, 0.6) !important; }
        .border-gray-100 { border-color: rgba(255, 255, 255, 0.04) !important; }
        .border-gray-200 { border-color: rgba(255, 255, 255, 0.08) !important; }
        .border-satelink-border { border-color: rgba(255, 255, 255, 0.08) !important; }
        
        /* Badges */
        .bg-emerald-50 { background-color: rgba(16, 185, 129, 0.15) !important; border-color: rgba(16, 185, 129, 0.3) !important; color: #34d399 !important; text-shadow: 0 0 10px rgba(52, 211, 153, 0.5); }
        .bg-blue-50 { background-color: rgba(59, 130, 246, 0.15) !important; border-color: rgba(59, 130, 246, 0.3) !important; color: #60a5fa !important; text-shadow: 0 0 10px rgba(96, 165, 250, 0.5); }
        .bg-red-50 { background-color: rgba(239, 68, 68, 0.15) !important; border-color: rgba(239, 68, 68, 0.3) !important; color: #f87171 !important; }
        .bg-amber-50 { background-color: rgba(245, 158, 11, 0.15) !important; border-color: rgba(245, 158, 11, 0.3) !important; color: #fbbf24 !important; }

        /* Tables */
        table thead tr th { color: #94a3b8 !important; background-color: rgba(15, 23, 42, 0.8) !important; border-bottom: 1px solid rgba(255, 255, 255, 0.08) !important; }
        table tbody tr:hover { background-color: rgba(255, 255, 255, 0.03) !important; }
        
        /* Links & Interactive */
        a { transition: all 0.2s ease; }
        a:hover { filter: brightness(1.2); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        
        /* Layout Sidebar */
        aside {
            background: linear-gradient(180deg, rgba(15, 23, 42, 0.9) 0%, rgba(7, 10, 17, 0.95) 100%) !important;
            backdrop-filter: blur(20px) !important;
            border-right: 1px solid rgba(255, 255, 255, 0.05) !important;
        }

        /* Glow effects for buttons */
        .glow-btn {
            position: relative;
        }
        .glow-btn::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, #0ea5e9, #10b981, #0ea5e9);
            z-index: -1;
            border-radius: inherit;
            filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .glow-btn:hover::before { opacity: 0.6; }

    </style>
    <script src="/js/dashboard.js" defer></script>
</head>
<body class="flex h-screen overflow-hidden antialiased selection:bg-satelink-accent selection:text-white">

    <!-- Sidebar Navigation -->
    <aside class="w-64 flex flex-col shadow-2xl z-20 relative">
        <div class="h-16 flex items-center px-6 border-b border-white/5">
            <i class="fas fa-satellite-dish text-satelink-accent text-xl mr-3 animate-pulse"></i>
            <span class="text-xl font-extrabold tracking-wider bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">SATELINK</span>
        </div>
        
        <nav class="flex-1 overflow-y-auto px-4 py-6 space-y-1 custom-scrollbar">
            <% 
                // Determine portal context from activePage
                let portal = 'admin';
                if (typeof activePage !== 'undefined') {
                    if (['builder', 'builder_docs', 'builder_login', 'projects'].includes(activePage)) portal = 'builder';
                    if (['operator', 'node', 'distributor'].includes(activePage)) portal = 'operator';
                    if (['support'].includes(activePage)) portal = 'support';
                }
            %>

            <% if (portal === 'admin') { %>
                <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-3 mt-4">Command Center</div>
                <a href="/ui/admin" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all <%= typeof activePage !=='undefined' && activePage==='overview' ? 'bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]' : 'text-slate-400 hover:text-white hover:bg-white/5' %>">
                    <i class="fas fa-chart-line w-5 text-center"></i> <span>Overview</span>
                </a>
                <a href="/ui/admin/nodes" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all <%= typeof activePage !=='undefined' && activePage==='nodes' ? 'bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]' : 'text-slate-400 hover:text-white hover:bg-white/5' %>">
                    <i class="fas fa-server w-5 text-center"></i> <span>Fleet</span>
                </a>
                <a href="/ui/admin/ledger" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all <%= typeof activePage !=='undefined' && activePage==='ledger' ? 'bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]' : 'text-slate-400 hover:text-white hover:bg-white/5' %>">
                    <i class="fas fa-book w-5 text-center"></i> <span>Ledger</span>
                </a>
                <a href="/ui/admin/withdrawals" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all <%= typeof activePage !=='undefined' && activePage==='withdrawals' ? 'bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]' : 'text-slate-400 hover:text-white hover:bg-white/5' %>">
                    <i class="fas fa-money-bill-transfer w-5 text-center"></i> <span>Withdrawals</span>
                </a>
                <a href="/ui/admin/logs" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all <%= typeof activePage !=='undefined' && activePage==='logs' ? 'bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]' : 'text-slate-400 hover:text-white hover:bg-white/5' %>">
                    <i class="fas fa-terminal w-5 text-center"></i> <span>System Logs</span>
                </a>
            <% } %>

            <% if (portal === 'builder') { %>
                <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-3 mt-4">Builder Portal</div>
                <a href="/ui/builder" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all <%= typeof activePage !=='undefined' && activePage==='builder' ? 'bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]' : 'text-slate-400 hover:text-white hover:bg-white/5' %>">
                    <i class="fas fa-laptop-code w-5 text-center"></i> <span>Console</span>
                </a>
                <a href="/ui/builder/projects" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all <%= typeof activePage !=='undefined' && activePage==='projects' ? 'bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]' : 'text-slate-400 hover:text-white hover:bg-white/5' %>">
                    <i class="fas fa-layer-group w-5 text-center"></i> <span>Projects</span>
                </a>
                <a href="/ui/builder/docs" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all <%= typeof activePage !=='undefined' && activePage==='builder_docs' ? 'bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]' : 'text-slate-400 hover:text-white hover:bg-white/5' %>">
                    <i class="fas fa-book-open w-5 text-center"></i> <span>Documentation</span>
                </a>
            <% } %>

            <% if (portal === 'operator') { %>
                <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-3 mt-4">Node Operations</div>
                <!-- Let operator view link natively resolve if context passed -->
                <a href="#" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]">
                    <i class="fas fa-satellite w-5 text-center"></i> <span>My Node</span>
                </a>
                <a href="/support" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all text-slate-400 hover:text-white hover:bg-white/5">
                    <i class="fas fa-headset w-5 text-center"></i> <span>Support</span>
                </a>
            <% } %>
            
            <% if (portal === 'support') { %>
                <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-3 mt-4">Diagnostics</div>
                <a href="/support" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all bg-satelink-accent/20 text-satelink-accent font-medium shadow-[inset_2px_0_0_0_#0ea5e9]">
                    <i class="fas fa-wrench w-5 text-center"></i> <span>Support Portal</span>
                </a>
                <a href="/health" target="_blank" class="flex items-center space-x-3 px-3 py-2.5 rounded-lg transition-all text-slate-400 hover:text-white hover:bg-white/5">
                    <i class="fas fa-heartbeat w-5 text-center"></i> <span>Health Check (JSON)</span>
                </a>
            <% } %>
        </nav>

        <div class="p-4 border-t border-white/5">
            <a href="/ui/logout" class="flex items-center space-x-3 px-3 py-2.5 text-sm text-red-400 hover:text-red-300 hover:bg-red-400/10 rounded-lg transition-all">
                <i class="fas fa-sign-out-alt w-5 text-center"></i> <span>Disconnect</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 flex flex-col min-w-0 relative h-screen">
        <!-- Top Navigation Bar for Mobile & Breadcrumbs -->
        <header class="h-16 flex border-b border-white/5 bg-[#0B0D17]/80 backdrop-blur-md items-center justify-between px-6 z-10 sticky top-0">
            <div class="flex items-center">
                <button class="md:hidden text-slate-400 hover:text-white mr-4 transition-colors">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                <div class="hidden sm:flex text-sm text-slate-400 font-medium">
                    <span class="text-satelink-accent mr-2 mt-px"><i class="fas fa-network-wired"></i></span>
                    <span class="tracking-wide uppercase text-xs">Platform Environment</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 bg-emerald-500/10 px-3 py-1.5 rounded-full border border-emerald-500/20 shadow-[0_0_10px_rgba(16,185,129,0.1)] cursor-pointer hover:bg-emerald-500/20 transition-colors">
                    <div class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse shadow-[0_0_5px_#34d399]"></div>
                    <span class="text-xs font-semibold text-emerald-400 tracking-wider">SYSTEM ONLINE</span>
                </div>
                
                <div class="w-8 h-8 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-slate-400 hover:text-white cursor-pointer transition-colors hover:bg-slate-700">
                    <i class="fas fa-user text-sm"></i>
                </div>
            </div>
        </header>

        <!-- Dynamic View Content Starts Here -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar relative z-0">