server {
    listen 80;
    server_name beta.satelink.example.com; # REPLACE WITH YOUR DOMAIN

    # Redirect HTTP to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name beta.satelink.example.com; # REPLACE WITH YOUR DOMAIN

    # SSL Certs (Managed by Certbot usually)
    # ssl_certificate /etc/letsencrypt/live/beta.satelink.example.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/beta.satelink.example.com/privkey.pem;

    # Frontend (Next.js)
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Backend API + SSE
    location /api {
        # Rewrite /api/foo -> /foo if your backend expects root paths
        # BUT our backend expects specific paths. 
        # If NEXT_PUBLIC_API_BASE_URL is https://beta.../api, then requests go to /api/...
        # Current backend structure: /admin-api, /auth, /me mounted at root.
        # We need to map /api requests to backend or just proxy specific expected prefixes?
        
        # Strategy: Proxy everything that isn't frontend to backend?
        # Better: Explicitly proxy known API prefixes.
        return 404; # Explicitly configured below
    }

    # Proxy specific backend routes referenced in server.js
    # /auth, /me, /admin-api, /admin, /node-api, /builder-api, /dist-api, /pair, /stream, /health
    
    # 1. Auth & Me
    location /auth {
        proxy_pass http://localhost:8080/auth;
        proxy_set_header Host $host;
    }
    location /me {
        proxy_pass http://localhost:8080/me;
        proxy_set_header Host $host;
    }

    # 2. Admin
    location /admin-api {
        proxy_pass http://localhost:8080/admin-api;
        proxy_set_header Host $host;
    }
    # Be careful not to conflict with Next.js /admin pages
    # Next.js handles /admin/* pages. 
    # server.js has app.use('/admin', ...) which conflicts if we proxy /admin to backend.
    # Frontend Pages: /admin/users, /admin/nodes
    # Backend Alias: /admin -> admin-api router
    # SOLUTION: DO NOT proxy /admin to backend if frontend needs it for routing pages.
    # The /admin alias in server.js was for CURL convenience.
    # In production, web traffic to /admin hits Next.js.
    # API traffic should hit /admin-api.
    
    # 3. Functional APIs
    location /node-api {
        proxy_pass http://localhost:8080/node-api;
        proxy_set_header Host $host;
    }
    location /builder-api {
        proxy_pass http://localhost:8080/builder-api;
        proxy_set_header Host $host;
    }
    location /dist-api {
        proxy_pass http://localhost:8080/dist-api;
        proxy_set_header Host $host;
    }
    location /pair {
        proxy_pass http://localhost:8080/pair;
        proxy_set_header Host $host;
    }
    location /stream {
        proxy_pass http://localhost:8080/stream;
        proxy_ignore_client_abort on;  # Important for SSE
        proxy_set_header Connection '';
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_buffering off;           # Important for SSE
        proxy_cache off;
    }
    location /health {
        proxy_pass http://localhost:8080/health;
        proxy_set_header Host $host;
    }
}
