worker_processes 1;

events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    upstream satelink_api {
        server 127.0.0.1:8080;
    }

    upstream satelink_web {
        server 127.0.0.1:3000;
    }

    server {
        listen 8000; # Staging Port (Change to 80 for Production)
        server_name localhost;

        # Security Headers
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";

        # 1. API & Backend Routes
        location ~ ^/(api|auth|admin-api|node-api|dist-api|ent-api|builder-api|pair|webhooks|__test) {
            proxy_pass http://satelink_api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # 2. Swagger Docs
        location /api-docs {
            proxy_pass http://satelink_api;
            proxy_set_header Host $host;
        }

        # 3. Stream (SSE)
        location /stream {
            proxy_pass http://satelink_api;
            proxy_http_version 1.1;
            proxy_set_header Connection '';
            proxy_set_header Host $host;
            proxy_buffering off;
            proxy_cache off;
            chunked_transfer_encoding off;
        }

        # 4. Frontend (Next.js) - Default Fallback
        location / {
            proxy_pass http://satelink_web;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
}
