# ── Stage 1: install & build ───────────────────────────────────────────────────
FROM node:20-slim AS builder

WORKDIR /app

# Copy manifests first for cache efficiency
COPY package*.json ./

# Use npm install instead of npm ci — avoids a known npm bug where
# "Exit handler never called" causes ci to fail silently on node:20-slim.
# --prefer-offline speeds up rebuilds when node_modules cache layer is warm.
RUN npm install

# Copy source
COPY . .

# Build Next.js production bundle
# INTERNAL_API_URL is NOT needed at build time (only used at runtime by next.config.ts)
# NEXT_PUBLIC_* vars must be present at build time if they are inlined by the compiler
ENV NEXT_PUBLIC_API_BASE=http://localhost:8080
RUN npm run build

# ── Stage 2: runtime ───────────────────────────────────────────────────────────
FROM node:20-slim

RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy full build output (incl. node_modules) from builder
COPY --from=builder /app /app

# Non-root user
RUN groupadd -r satelink && useradd -r -g satelink satelink \
    && chown -R satelink:satelink /app
USER satelink

EXPOSE 3000

# INTERNAL_API_URL is injected by docker-compose at runtime so Next.js rewrites
# point to the Docker service alias 'api' rather than 'localhost'
CMD ["npm", "run", "start"]
